---
title: JS Hook
date: 2020-05-14 11:39:45
permalink: /pages/js-hook
article: false
---

## Hook Cookie

::: danger 注意
不推荐方法二，部分特性可能正准备或者已经从相关的 web 标准中移除，参考文档：[MDN](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineGetter__)
:::

<code-group>
  <code-block title="方法一" active>
  ```javascript
  (function () {
      var cookieCache = "";
      Object.defineProperty(document, "cookie", {
          set: function (val) {
              console.log("Hook set cookie => ", val);
              if (val.indexOf("spiderapi.cn") !== -1) {
                  debugger;
              }
              cookieCache = val;
              return val;
          },
          get: function () {
              return cookieCache;
          }
      });
  })();
  ```
  </code-block>

  <code-block title="方法二">
  ```javascript
  (function () {
      var cookieCache = document.cookie.__lookupSetter__("cookie");
      document.__defineSetter__("cookie", function (val) {
          console.log("Hook set cookie => ", val);
          if (val.indexOf("spiderapi.cn") !== -1) {
              debugger;
          }
          cookieCache = val;
      });
      document.__defineGetter__("cookie", function () {
          return cookieCache;
      });
  })();
  ```
  </code-block>
</code-group>

## Hook Request Header

```javascript
(function () {
    var headerCache = window.XMLHttpRequest.prototype.setRequestHeader;
    window.XMLHttpRequest.prototype.setRequestHeader = function (key, value) {
        console.log("Hook set header %s => %s", key, value);
        if (key === "spiderapi.cn") {
            debugger;
        }
        return headerCache.apply(this, arguments);
    };
})();
```

## Hook Debugger

<code-group>
  <code-block title="方法一：constructor" active>
  ```javascript
  (function () {
      var constructorCache = Function.prototype.constructor;
      Function.prototype.constructor = function (string) {
          if (string === "debugger") {
              console.log("Hook constructor debugger!")
              return function () {};
          }
          return constructorCache(string);
      };
  })();
  ```
  </code-block>

  <code-block title="方法二：setInterval">
  ```javascript
  (function () {
      var setIntervalCache = setInterval
      setInterval = function (func, delay) {
          if (func.toString().indexOf("debugger") !== -1) {
              console.log("Hook setInterval debugger!")
              return function () {};
          }
          return setIntervalCache(func, delay)
      };
  })();
  ```
  </code-block>

  <code-block title="方法三：setTimeout">
  ```javascript
  (function () {
      var setTimeoutCache = setTimeout;
      setTimeout = function (func, delay) {
          if (func.toString().indexOf("debugger") !== -1) {
              console.log("Hook setTimeout debugger!")
              return function () {};
          }
          return setTimeoutCache(func, delay);
      };
  })();
  ```
  </code-block>

  <code-block title="方法四：eval">
  ```javascript
  (function () {
      var evalCache = window.eval;
      window.eval = function (string) {
          if(string.includes("debugger")){
              console.log("Hook eval debugger!")
          }
          return evalCache(string.replace(/debugger\s*;?/g, ""));
      };
      window.eval.toString = function () {
          return evalCache.toString();
      };
  })();
  ```
  </code-block>
</code-group>

## Hook XHR

```javascript
(function () {
    var openCache = window.XMLHttpRequest.prototype.open;
    window.XMLHttpRequest.prototype.open = function(method, url) {
        console.log("Hook xhr method => %s, url => %s", method, url);
        if (url.indexOf("spiderapi.cn") !== -1) {
            debugger;
        }
        return openCache.apply(this, arguments);
    };
})();
```

## Hook fetch

```javascript
(function() {
    var fetchCache = Object.getOwnPropertyDescriptor(window, "fetch")
    Object.defineProperty(window, "fetch", {
        value: function (url) {
            console.log("Hook fetch url => ", url)
            debugger;
            return fetchCache.value.apply(this, arguments)
        }
    })
})();
```

## Hook JSON.stringify

```javascript
(function() {
    var stringifyCache = JSON.stringify;
    JSON.stringify = function(params) {
        console.log("Hook JSON.stringify => ", params);
        debugger;
        return stringifyCache(params);
    }
})();
```

## Hook JSON.parse

```javascript
(function() {
    var parseCache = JSON.parse;
    JSON.parse = function(params) {
        console.log("Hook JSON.parse => ", params);
        debugger;
        return parseCache(params);
    }
})();
```

## Hook Function

以下代码执行后，所有的函数操作都会在控制台打印输出将要执行的 JS 源码。

```javascript
(function() {
    let FunctionCache = window.Function;
    let newFunction = function() {
        let src = arguments[arguments.length - 1];
        console.log("Hook Function => ", src);
        debugger;
        return FunctionCache.apply(this, arguments);
    };
    newFunction.toString = function() {
        return FunctionCache.toString();
    };
})();
```

## Hook WebSocket

```javascript
(function() {
    let sendCache = WebSocket.prototype.send;
    WebSocket.prototype.send = function (data){
        console.info("Hook WebSocket send => ", data);
        return sendCache(data)
    };
})();
```

## Hook eval

```javascript
(function () {
    var evalCache = window.eval;
    window.eval = function (string) {
        console.log("Hook eval =>", string);
        debugger;
        return evalCache(string);
    };
    window.eval.toString = function () {
        return evalCache.toString();
    };
})();
```

## Hook setInterval

```javascript
(function () {
    var setIntervalCache = setInterval;
    setInterval = function (func, delay) {
        console.log("Hook setInterval func => %s, delay => %s", func, delay);
        debugger;
        return setIntervalCache(func, delay);
    };
})();
```

## Hook setTimeout

```javascript
(function () {
    var setTimeoutCache = setTimeout;
    setTimeout = function (func, delay) {
        console.log("Hook setTimeout func => %s, delay => %s", func, delay);
        debugger;
        return setTimeoutCache(func, delay);
    };
})();
```

## Hook RegExp

```javascript
(function () {
    let RegExpCache = RegExp;
    RegExp = function(pattern, flags) {
        console.log("Hook RegExp pattern => %s, flags => %s", pattern, flags);
        debugger;
        return RegExpCache(pattern, flags);
    };
})();
```

## Hook Canvas

```javascript
(function() {
    let createElementCache = document.createElement;
    document.createElement = function(tagName) {
        console.info("Hook createElement tagName => ", tagName);
        if(tagName === "canvas") {
            debugger;
        }
        return createElementCache(tagName);
    };
})();
```

## Hook createElement

```javascript
(function() {
    var createElementCache = document.createElement;
    document.createElement = function(tagName) {
        console.info("Hook createElement tagName => ", tagName);
        if(tagName === "div") {
            debugger;
        }
        return createElementCache(tagName);
    };
})();
```

## Hook getElementById

```javascript
(function() {
    var getElementByIdCache = document.getElementById;
    document.getElementById = function(id) {
        console.info("Hook getElementById id => ", id);
        if(id === "spiderapi") {
            debugger;
        }
        return getElementByIdCache(id);
    };
})();
```

## Hook setAttribute

```javascript
(function() {
    var setAttributeCache = window.Element.prototype.setAttribute;
    window.Element.prototype.setAttribute = function(name, value) {
        console.info("Hook setAttribute name => %s, value => %s", name, value);
        if(name === "spiderapi") {
            debugger;
        }
        return setAttributeCache(name, value);
    };
})();
```

## 清除定时器

```javascript
for (let i = 1; i < 99999; i++) window.clearInterval(i);
```


## Hook 通用模板

```javascript
(function () {
    var oldFunc = func;
    func = function(arguments){
        console.log(arguments)
        return oldFunc.apply(arguments)
    };
})();
```